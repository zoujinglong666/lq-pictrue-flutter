# å›¾ç‰‡ç‚¹èµçŠ¶æ€åŒæ­¥å®ç°æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜æè¿°
ç”¨æˆ·åœ¨è¯¦æƒ…é¡µç‚¹èµåï¼Œè¿”å›é¦–é¡µæ—¶ç‚¹èµçŠ¶æ€æœªåŒæ­¥æ›´æ–°ï¼Œå¯¼è‡´åˆ—è¡¨ä¸­æ˜¾ç¤ºçš„ç‚¹èµæ•°å’Œç‚¹èµçŠ¶æ€ä¸å®é™…ä¸ä¸€è‡´ã€‚

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆé€‰æ‹©
é‡‡ç”¨ **Provider å…¨å±€çŠ¶æ€ç®¡ç†æ¨¡å¼**ï¼Œä¸é¡¹ç›®ç°æœ‰çš„ `UnreadProvider` è®¾è®¡ä¿æŒä¸€è‡´ï¼Œç¬¦åˆé¡¹ç›®æ¶æ„è§„èŒƒã€‚

### æ ¸å¿ƒç»„ä»¶

#### 1. `PictureUpdateProvider` (æ–°å¢)
**æ–‡ä»¶è·¯å¾„**: `lib/providers/picture_update_provider.dart`

**åŠŸèƒ½**:
- æä¾›å…¨å±€å›¾ç‰‡æ›´æ–°äº‹ä»¶é€šçŸ¥æœºåˆ¶
- å½“å›¾ç‰‡çŠ¶æ€å˜åŒ–ï¼ˆç‚¹èµã€æ”¶è—ç­‰ï¼‰æ—¶ï¼Œå‘é€æ›´æ–°äº‹ä»¶
- æ‰€æœ‰ç›‘å¬è¯¥ Provider çš„é¡µé¢è‡ªåŠ¨æ¥æ”¶æ›´æ–°å¹¶åˆ·æ–°UI

**å…³é”®ä»£ç **:
```dart
/// å›¾ç‰‡æ›´æ–°äº‹ä»¶
class PictureUpdateEvent {
  final String pictureId;
  final PictureVO updatedPicture;
  final DateTime timestamp;
}

/// å›¾ç‰‡æ›´æ–°é€šçŸ¥å™¨
class PictureUpdateNotifier extends StateNotifier<PictureUpdateEvent?> {
  void notifyPictureUpdate(PictureVO picture) {
    state = PictureUpdateEvent(
      pictureId: picture.id,
      updatedPicture: picture,
    );
  }
}
```

#### 2. è¯¦æƒ…é¡µä¿®æ”¹
**æ–‡ä»¶è·¯å¾„**: `lib/pages/detail_page.dart`

**æ”¹åŠ¨ç‚¹**:
1. å¯¼å…¥ `picture_update_provider.dart`
2. åœ¨ç‚¹èµæˆåŠŸåï¼Œé€šè¿‡ Provider å‘é€æ›´æ–°äº‹ä»¶

**å…³é”®ä»£ç **:
```dart
// ç‚¹èµæˆåŠŸå
setState(() {
  _imageDetails = _imageDetails.copyWith(
    hasLiked: result.liked,
    likeCount: result.likeCount.toString(),
  );
});

// é€šçŸ¥å…¨å±€çŠ¶æ€æ›´æ–°ï¼ˆåŒæ­¥åˆ°é¦–é¡µç­‰å…¶ä»–é¡µé¢ï¼‰
ref.read(pictureUpdateProvider.notifier).notifyPictureUpdate(_imageDetails);
```

#### 3. é¦–é¡µä¿®æ”¹
**æ–‡ä»¶è·¯å¾„**: `lib/pages/home_page.dart`

**æ”¹åŠ¨ç‚¹**:
1. å¯¼å…¥ `picture_update_provider.dart`
2. åœ¨ `initState` ä¸­ç›‘å¬ Provider äº‹ä»¶
3. æ”¶åˆ°æ›´æ–°äº‹ä»¶æ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨ `_updatePictureInList` æ›´æ–°åˆ—è¡¨

**å…³é”®ä»£ç **:
```dart
@override
void initState() {
  // ... å…¶ä»–åˆå§‹åŒ–ä»£ç 
  
  // ç›‘å¬å›¾ç‰‡æ›´æ–°äº‹ä»¶ï¼ˆç‚¹èµã€æ”¶è—ç­‰ï¼‰
  ref.listenManual(pictureUpdateProvider, (previous, next) {
    if (next != null && mounted) {
      _updatePictureInList(next.updatedPicture);
    }
  });
}
```

## ğŸ¯ æŠ€æœ¯ä¼˜åŠ¿

### 1. **è§£è€¦è®¾è®¡**
- è¯¦æƒ…é¡µå’Œé¦–é¡µæ— éœ€ç›´æ¥è€¦åˆ
- é€šè¿‡ Provider ä¸­ä»‹å®ç°æ¾è€¦åˆé€šä¿¡
- æœªæ¥å¯è½»æ¾æ‰©å±•åˆ°å…¶ä»–é¡µé¢ï¼ˆæ”¶è—é¡µã€ä¸ªäººä¸­å¿ƒç­‰ï¼‰

### 2. **å®æ—¶å“åº”**
- ç‚¹èµåç«‹å³åŒæ­¥ï¼Œæ— éœ€ç­‰å¾…è¿”å›é¦–é¡µ
- å¤šé¡µé¢åŒæ—¶æ‰“å¼€æ—¶ï¼Œæ‰€æœ‰é¡µé¢è‡ªåŠ¨æ›´æ–°
- ç”¨æˆ·ä½“éªŒæµç•…è‡ªç„¶

### 3. **ç¬¦åˆé¡¹ç›®è§„èŒƒ**
- ä¸ `UnreadProvider` è®¾è®¡ä¸€è‡´
- ä½¿ç”¨ Riverpod çŠ¶æ€ç®¡ç†ï¼ˆé¡¹ç›®å·²ä½¿ç”¨ï¼‰
- ä¸ SSE å®æ—¶é€šä¿¡æ¨¡å¼äº’è¡¥

### 4. **æ˜“äºæ‰©å±•**
- å¯å¤ç”¨äºæ”¶è—ã€è¯„è®ºç­‰å…¶ä»–æ“ä½œ
- æ”¯æŒå¤šç§å›¾ç‰‡çŠ¶æ€åŒæ­¥åœºæ™¯
- äº‹ä»¶åŒ…å«æ—¶é—´æˆ³ï¼Œæ”¯æŒå»é‡å’Œæ’åº

## ğŸ“¦ ç›¸å…³æ–‡ä»¶

### æ–°å¢æ–‡ä»¶
- `lib/providers/picture_update_provider.dart` - å›¾ç‰‡æ›´æ–°çŠ¶æ€ç®¡ç†

### ä¿®æ”¹æ–‡ä»¶
- `lib/pages/detail_page.dart` - æ·»åŠ ç‚¹èµåçš„å…¨å±€é€šçŸ¥
- `lib/pages/home_page.dart` - ç›‘å¬å¹¶å“åº”å›¾ç‰‡æ›´æ–°äº‹ä»¶

## ğŸš€ ä½¿ç”¨æ•ˆæœ

1. **ç”¨æˆ·åœ¨è¯¦æƒ…é¡µç‚¹èµ** â†’ è§¦å‘ API è¯·æ±‚
2. **ç‚¹èµæˆåŠŸ** â†’ æ›´æ–°è¯¦æƒ…é¡µçŠ¶æ€ + å‘é€ Provider äº‹ä»¶
3. **é¦–é¡µç›‘å¬åˆ°äº‹ä»¶** â†’ è‡ªåŠ¨æŸ¥æ‰¾å¹¶æ›´æ–°åˆ—è¡¨ä¸­å¯¹åº”çš„å›¾ç‰‡
4. **UI å®æ—¶åˆ·æ–°** â†’ ç‚¹èµæ•°å’Œç‚¹èµçŠ¶æ€åŒæ­¥æ˜¾ç¤º

## ğŸ”„ æ‰©å±•å»ºè®®

æœªæ¥å¯å°†è¯¥æœºåˆ¶æ‰©å±•åˆ°:
- âœ… æ”¶è—é¡µé¢çš„ç‚¹èµåŒæ­¥
- âœ… ä¸ªäººä¸­å¿ƒçš„å›¾ç‰‡çŠ¶æ€åŒæ­¥
- âœ… æœç´¢ç»“æœé¡µçš„å®æ—¶æ›´æ–°
- âœ… è¯„è®ºæ•°ã€æµè§ˆæ•°ç­‰å…¶ä»–çŠ¶æ€åŒæ­¥

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ç”Ÿå‘½å‘¨æœŸç®¡ç†**: ä½¿ç”¨ `ref.listenManual` åœ¨ç»„ä»¶é”€æ¯æ—¶è‡ªåŠ¨å–æ¶ˆç›‘å¬
2. **çŠ¶æ€æ ¡éªŒ**: æ›´æ–°å‰æ£€æŸ¥ `mounted` çŠ¶æ€ï¼Œé¿å…å†…å­˜æ³„æ¼
3. **æ€§èƒ½ä¼˜åŒ–**: ä»…æ›´æ–°åŒ¹é… ID çš„å›¾ç‰‡ï¼Œé¿å…å…¨å±€åˆ·æ–°

## ğŸ“š å‚è€ƒ

- Riverpod å®˜æ–¹æ–‡æ¡£: https://riverpod.dev/
- é¡¹ç›®ç°æœ‰ Provider: `lib/providers/unread_provider.dart`
- SSE å®æ—¶é€šä¿¡: `lib/services/sse_service.dart`
